@model UserViewModel
<div id="toastContainer" aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>
<div class="container-fluid px-lg-4">
    <!-- User Form Modal -->
    <div class="modal fade" id="userFormModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white rounded-top">
                    <h5 class="modal-title font-weight-600">
                        <i class="fas fa-user-edit mr-2"></i>Create New User
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body py-4">
                    @await Html.PartialAsync("_UserPartial", new User())
                </div>
            </div>
        </div>
    </div>

    <!-- User List Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom-0">
                    <h3 class="h5 mb-0 text-primary font-weight-600">
                        <i class="fas fa-users mr-2"></i>User Management
                    </h3>
                    <button id="showUserForm" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus-circle mr-2"></i>New User
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive rounded-lg">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 font-weight-600 text-uppercase small">Name</th>
                                    <th class="border-0 font-weight-600 text-uppercase small">Email</th>
                                    <th class="border-0 font-weight-600 text-uppercase small text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in Model.Users)
                                {
                                    <tr class="hover-shadow">
                                        <td class="align-middle">@user.Name</td>
                                        <td class="align-middle text-muted">@user.Email</td>
                                        <td class="align-middle text-right">
                                            <div class="btn-group btn-group-sm">
                                                <a href="/User/Edit/@user.Id" class="btn btn-outline-secondary">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </a>
                                                <a href="/User/Delete/@user.Id" class="btn btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SOAP Integration Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h3 class="h5 mb-0 text-primary font-weight-600">
                        <i class="fas fa-code mr-2"></i>SOAP Integration
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <button id="load-soap" class="btn btn-outline-dark btn-block">
                                <i class="fas fa-download mr-2"></i>Fetch Data
                            </button>
                        </div>
                        <div class="col-md-8">
                            <pre id="soap-content" class="m-0 p-3 bg-light rounded border"
                                 style="min-height: 150px; max-height: 300px; font-family: 'Fira Code', monospace;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/site.js"></script>
    <script>
        $(document).ready(function () {
           
            $('#showUserForm').click(function () {
                $('#userFormModal').modal('show');
            });

            // Handle form submission
            $('#userForm').submit(function (e) {
                e.preventDefault();
                const $form = $(this);
                $.ajax({
                    url: '@Url.Action("UserForm", "User")',
                    method: 'POST',
                    data: $form.serialize(),
                    beforeSend: function () {
                        $form.find('button').prop('disabled', true)
                            .html('<i class="fas fa-spinner fa-spin fa-fw mr-2"></i>Processing...');
                    },
                    success: function (response) {
                        $('#userFormModal').modal('hide');
                        showToast('<i class="fas fa-check-circle mr-2"></i>User saved successfully!', 'success');
                        $form.trigger("reset");
                        $form.find('.text-danger').text('');
                        //window.location.reload();
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            const errors = xhr.responseJSON;
                            $.each(errors, function (key, value) {
                                $form.find('[data-valmsg-for="' + key + '"]').text(value);
                            });
                        } else {
                            showToast('<i class="fas fa-exclamation-triangle mr-2"></i>Error saving user: ' + xhr.statusText, 'danger');
                        }
                    },
                    complete: function () {
                        $form.find('button').prop('disabled', false)
                            .html('<i class="fas fa-save fa-fw mr-2"></i>Submit');
                    }
                });
            });

            // Toast notification function
            function showToast(message, type = 'info') {
                const bgColorClass = {
                    info: 'bg-primary',
                    success: 'bg-success',
                    warning: 'bg-warning',
                    danger: 'bg-danger'
                };
                const toast = $(`
                    <div class="toast fade align-items-center text-white ${bgColorClass[type] || 'bg-info'}" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex align-items-center">
                            <div class="toast-body p-3">
                                ${message}
                            </div>
                            <button class="toast-close-btn" data-dismiss="toast" aria-label="Close">&times;</button>
                        </div>
                    </div>
                `);
                $('#toastContainer').append(toast);

                toast.toast({ delay: 3000 }).toast('show');
                toast.on('hidden.bs.toast', () => {
                    toast.remove();
                });
            }
        });
        $('#load-soap').click(function () {
            const $btn = $(this);
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Fetching...');

            fetch('/api/api/soap')
                .then(response => response.text())
                .then(data => {
                    $('#soap-content').text(data).addClass('border border-success');
                })
                .catch(error => {
                    $('#soap-content').html(`
                                    <span class="text-danger">
                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                        ${error.message}
                                    </span>
                                `).addClass('border border-danger');
                })
                .finally(() => {
                    $btn.prop('disabled', false).html('<i class="fas fa-cloud-download-alt mr-2"></i>Fetch SOAP Data');
                });
        });
    </script>
}